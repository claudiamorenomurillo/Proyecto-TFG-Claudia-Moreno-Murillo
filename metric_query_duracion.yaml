pg_top_queries_per_database:
  query: |
    WITH ranked_queries AS (
        SELECT 
            pgd.datname, 
            query,
            calls, 
            mean_exec_time, 
            calls * mean_exec_time AS total_mean_time,
            ROW_NUMBER() OVER (PARTITION BY pgd.datname ORDER BY pgd.datname DESC) AS r
        FROM 
            pg_stat_statements pgs
        INNER JOIN 
            pg_user pgu ON pgs.userid = pgu.usesysid
        INNER JOIN 
            pg_database pgd ON pgd.oid = pgs.dbid
        WHERE 
            pgu.usename NOT IN ('postgres_exporter', 'postgres', 'pgpool2', 'cloudsqladmin', 'cloudsqlagent') 
            AND pgd.datname NOT IN ('postgres', 'template0', 'template1')
            AND calls > 100 
            AND mean_exec_time > 100
        ORDER BY mean_exec_time DESC
    ),
    top_queries AS (
        SELECT 
            datname, 
            query, 
            calls, 
            mean_exec_time, 
            total_mean_time
        FROM 
            ranked_queries
        WHERE 
            r <= 5
    ),
    all_databases AS (
        SELECT datname FROM pg_database WHERE datname NOT IN ('postgres', 'template0', 'template1')
    )
    SELECT 
        ad.datname,
        COALESCE(tq.query, 'sin query con mÃ¡s de 100ms') AS query,
        COALESCE(tq.calls, 0) AS calls,
        COALESCE(tq.mean_exec_time, 0) AS mean_exec_time,
        COALESCE(tq.total_mean_time, 0) AS total_mean_time
    FROM 
        all_databases ad
    LEFT JOIN 
        top_queries tq ON ad.datname = tq.datname
    ORDER BY 
        ad.datname, 
        tq.total_mean_time DESC;

  metrics:
    - datname:
        usage: "LABEL"
        description: "Base de datos"
    - query:
        usage: "LABEL"
        description: "Consulta SQL"
    - calls:
        usage: "COUNTER"
        description: "Numero de llamadas"
    - mean_exec_time:
        usage: "GAUGE"
        description: "Tiempo medio de ejec(ms)"
    - total_mean_time:
        usage: "GAUGE"
        description: "Tiempo medio total de ejec (ms)"
